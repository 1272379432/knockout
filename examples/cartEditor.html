<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<title>Knockout Examples</title>
        <link rel="Stylesheet" href="styles.css" />
        <script type="text/javascript" src="../lib/jquery-1.4.2.js"></script>
        <script type="text/javascript" src="../lib/jquery.tmpl.js"></script>
        <script type="text/javascript" src="../lib/json2.js"></script>
        <script type="text/javascript" src="../build/knockout-debug.js"></script>
        </style>
	</head>
	<body>
        <div id="header">
            <div class="menu"><a href="../homepage.html">Home</a>|<a href="index.html">Examples</a>|<a href="http://github.com/SteveSanderson/knockout/downloads">Download</a></div>
            <a class="logo" href="/"><img src="resources/knockout-logo.png" /></a>
        </div>
        <div id="main">
            <h1>Examples &raquo; Cart Editor</h1>
            
            <div id="cartEditor">
            	<table width="100%">
            		<thead>
            			<tr>
            				<th>Category</th>
            				<th>Product</th>
            				<th>Price</th>
            				<th>Quantity</th>
            				<th>Subtotal</th>
            				<th></th>
            			</tr>
            		</thead>
            		<tbody data-bind="template: {name: 'cartRowTemplate', foreach: lines}">
            	</table>
            	<div>Total value: <span data-bind="text: grandTotal">&nbsp;</span></div>
            	<button data-bind="click: addLine">Add product</button>
            	<button data-bind="click: save">Submit order</button>
            </div>
        </div>
        
        <script type="text/html" id="cartRowTemplate">
        	<tr>
        		<td><select data-bind="options: products.categories, optionsText: 'name', optionsCaption: 'Select...', value: category"></select></td>
        		<td><select data-bind="visible: category, options: category() ? category().products : null, optionsText: 'name', optionsCaption: 'Select...', value: product"></select></td>
        		<td><span data-bind="text: product() ? product().price : ''"></span></td>
        		<td><input data-bind="visible: product, value: quantity, valueUpdate: 'keyup'" /></td>
        		<td><span data-bind="visible: product, text: subtotal"></span></td>
        		<td><a href="#" data-bind="click: function() { cartViewModel.removeLine($data) }">Remove</a></td>
        	</tr>
        </script>

        <script type="text/javascript">
        	var products = {
				categories: [
					{ name: "Alpha", products: [
						{ name: "A1", price: 50 }, { name: "A2", price: 51 }, { name: "A3", price: 52 }
					]},
					{ name: "Beta", products: [
						{ name: "B1", price: 150 }, { name: "B2", price: 151 }
					]}
				],  		
        	};
        	
        	var cartLine = function() {
        		this.category = ko.observable();
        		this.product = ko.observable();
        		this.quantity = ko.observable(1);
        		
        		this.subtotal = ko.dependentObservable(function() {
        			return this.product() ? this.product().price * parseInt(this.quantity()) : 0;
    			}.bind(this));
        	};
        	var cart = function() {
        		// Stores an array of lines, and from these, can work out the grandTotal
        		this.lines = ko.observableArray([new cartLine()]);   // Put one line in by default     		
        		this.grandTotal = ko.dependentObservable(function() {
					var total = 0;
					for (var i = 0; i < this.lines().length; i++)
						total += this.lines()[i].subtotal();
					return total;
    			}.bind(this));
    			
    			// Operations
    			this.addLine = function() { this.lines.push(new cartLine()) };
    			this.removeLine = function(line) { this.lines.remove(line) };
    			this.save = function() {
    				var dataToSave = $.map(this.lines(), function(line) { 
    					return line.product() ? { productName: line.product().name, quantity: line.quantity() } : undefined     				
					});
    				alert("Could now send this to server: " + JSON.stringify(dataToSave));
    			};
        	};

			var cartViewModel = new cart();
            ko.applyBindings(document.getElementById("cartEditor"), cartViewModel);
        </script>
	</body>
</html>